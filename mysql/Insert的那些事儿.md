# 前序

最近在重写公司推送模块，包括推送关系、推送逻辑等，看着之前同事华丽的使用了replace into，而改造数据库结构之后，却出现了一些让人蛋疼的问题，比方说app每次绑定之后都新增一条记录。

之前负责开发的童鞋在设计数据库之初，只考虑了登录用户的情况，所以，user_id成了主键，而导致，只有用户登录APP的时候才会进行账号和设备的绑定。

而这种设计就导致，我们想要对所有APP用户进行推送的时候，只能使用第三方推送平台的批量推送功能，而很多我们可以想要实现的推送逻辑都没有办法很好的实现。

除此之外，因为user_id是主键，replace into的用法，会对其进行唯一检查，导致一个用户如果登录了多个设备，最后的设备才会是有效的，这导致了很多坑爹的情况，而用户解绑方面也会略显忧伤。

针对新的产品需求，我自然要进行一系列的改动，在这个过程中，对MySQL的Insert相关的几个操作也有了一定的应用，在此记录一下，防止以后再有用到的时候，会踩一些不必要的坑。

# Insert那些事儿

标准的SQL里面我们常说的增删改查也就是insert、delete、update、select语句。


```mysql
insert into table (a, b, c) values ("a", "b", "c");#最标准的插入语句
```


当然，更新，我们可以理解为先删除，再插入。

不过，写法可能就变成了


```mysql
#先删再加
delete from table where a = "a";
insert into table (a, b, c) values ("a", "b", "c");
#更新
update table set b = "b", c = "c" where a = "a";
```


不过,无论怎么操作，之前会select一次信息,然后再写入。

在查询到执行写操作之间，可能就会根据业务要求来进行一些判断了，比方说如果存在就更新，或者如果存在就不更新。

面对这些情况，贴心的MySQL就提供了他的方言（或者说俚语）

## replace into

replace into 会对表的主键或唯一键（没有唯一键会把主键作为唯一键）进行检查，如果插入字段，唯一键存在，则更新，不存在则插入

## insert ignore

insert ignore 会对标的主键或唯一键进行检查,insert语句如果包括主键或唯一键，则检查信息是否存在，存在则放弃插入，不存在则插入

这两个MySQL的方言，可以让我们本来需要检查、判断、执行的程序，直接简化成一条SQL语句，大大精简了开发工作，不过需要对主键和唯一键设置有要求。

# 总结

insert 插入新的数据

replace into 数据存在时保留最新数据

insert ignore 数据存在时保留旧的数据

# 坑

1. 注意唯一键和主键，如果修改的语句不存在唯一键或主键，那么replace into和insert ignore 只是普通的insert，会出现重复数据
2. replace into会先删除后插入，故出现自增主键就会让表数据支离破碎，如果有自增主键，感觉就会有点不太开心了，运用时需注意
